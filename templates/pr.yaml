apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: create-api-pr-production-wt
spec:
  entrypoint: create-pr
  templates:
    - name: create-pr
      inputs:
        artifacts:
          - name: catalog-file
            path: /tmp/catalog.yaml
          - name: deploy-file
            path: /tmp/deploy.yaml
      arguments:
        parameters:
          - name: commit_message
          - name: branch_name
          - name: api_name
      script:
        image: claudioed/githucli
        command: [bash]
        env:
          - name: GH_TOKEN
            valueFrom:
              secretKeyRef:
                name: github-secret
                key: GH_TOKEN
        source: |
          git clone https://apirator:${GH_TOKEN}@github.com/apirator/workflow-manifests.git
          cd workflow-manifests && \
          git checkout -b {{arguments.parameters.branch_name}} && \
          echo "writing files " && \
          cat /tmp/catalog.yaml >> catalogs/{{arguments.parameters.api_name}}.yaml && \
          cat /tmp/deploy.yaml >> apis/{{arguments.parameters.api_name}}.yaml && \
          git status && \
          echo "configuring github user" && \
          git config --global user.email "apirator@gmail.com" && \
          git config --global user.name "apirator" && \
          echo "adding files " && \
          git add catalogs/{{arguments.parameters.api_name}}.yaml && \
          git add apis/{{arguments.parameters.api_name}}.yaml && \
          git status && \
          echo "commiting files " && \
          git commit -m "new api" && \
          echo "pushing files " && \
          git push -u origin {{arguments.parameters.branch_name}} && \
          gh pr create --head {{arguments.parameters.branch_name}} --base main --title "New API " --body "API"
